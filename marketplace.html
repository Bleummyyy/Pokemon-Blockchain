<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <meta http-equiv="Content-Security-Policy" 
      content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;
               connect-src 'self' https: http://127.0.0.1:5500 http://localhost:5500;
               script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
               style-src 'self' 'unsafe-inline' https:;
               img-src 'self' data: https: blob:;">

  <title>Pok√©Market</title>
  <link rel="stylesheet" href="css/marketplace.css"/>

  <script src="js/ethers.js"></script>


<script src="./js/login.js"></script>        <!-- FIRST -->
<script src="./js/marketplace.js"></script>  <!-- SECOND -->

  <!-- ETHERS.JS -->
</head>
<body>
  <!-- NAVBAR -->
<nav class="navbar">
  <div class="left-group">
    <div class="logo">Pokemon R</div>
    <div class="wallet-info" id="wallet-info" style="display: none;">
      Wallet: <span id="address">0x...</span>
    </div>
  </div>

  <div class="right-group">
    <div class="pkn-balance" id="pkn-balance" style="display: none;">
      PKN: <span id="pkn-amount">0</span>
    </div>
    <a href="marketplace.html" class="nav-link">Marketplace</a>
    <a href="my-nfts.html" class="nav-link">Inventory</a>

    <!-- CONNECTED BUTTON -->
    <button class="nav-link login-btn" id="login-btn">
      <span>Login</span>
    </button>

    <!-- PROFILE IMAGE -->
    <img 
      src="https://avatars.githubusercontent.com/u/169036190?v=4&size=64" 
      alt="Profile" 
      class="nav-link profile-img" 
      onclick="toggleDropdown()">
  </div>
</nav>

<!-- DROPDOWN MENU -->
<div class="profile-dropdown" id="profile-dropdown" style="display: none;">
  <div class="dropdown-menu" id="dropdown-menu">
    <button onclick="logout()" class="logout-btn">Logout</button>
  </div>
</div>

  <!-- MAIN -->
  <div class="market-container">
    <header class="market-header">
      <h1>Pok√©mon NFT Marketplace</h1>

      <div class="filters-bar">
      <div class="filters">
        <!-- PRICE -->
        <select id="price-filter" onchange="applyFilters()">
          <option value="">Sort by Price</option>
          <option value="low">Low to High</option>
          <option value="high">High to Low</option>
        </select>

        <!-- RARITY -->
        <select id="rarity-filter" onchange="applyFilters()">
          <option value="">All Rarities</option>
          <option value="COMMON">Common</option>
          <option value="UNCOMMON">Uncommon</option>
          <option value="RARE">Rare</option>
          <option value="EPIC">Epic</option>
          <option value="LEGENDARY">Legendary</option>
        </select>

        <!-- TYPE -->
        <select id="type-filter" onchange="applyFilters()">
          <option value="">All Types</option>
          <option value="NORMAL">Normal</option>
          <option value="FIRE">Fire</option>
          <option value="WATER">Water</option>
          <option value="GRASS">Grass</option>
          <option value="ELECTRIC">Electric</option>
          <option value="ICE">Ice</option>
          <option value="FIGHTING">Fighting</option>
          <option value="POISON">Poison</option>
          <option value="GROUND">Ground</option>
          <option value="FLYING">Flying</option>
          <option value="PSYCHIC">Psychic</option>
          <option value="BUG">Bug</option>
          <option value="ROCK">Rock</option>
          <option value="GHOST">Ghost</option>
          <option value="DRAGON">Dragon</option>
          <option value="DARK">Dark</option>
          <option value="STEEL">Steel</option>
          <option value="FAIRY">Fairy</option>
        </select>

        <!-- SEARCH -->
        <input type="text" id="search-input" placeholder="Search Pok√©mon..." onkeyup="applyFilters()">
      </div>
    </div>
  </div>

      
      <!-- <p id="wallet-info" style="display:none;">
        Connected: <span id="address"></span>
      </p> -->
    </header>

<!-- GACHA MINTING SECTION -->
<div class="gacha-section">
    <div class="gacha-header">
        <h2>üéÆ Pok√©mon Gacha Machine</h2>
        <p>Mint random Pok√©mon and discover rare creatures!</p>
    </div>
    
    <div class="gacha-options">
        <!-- Single Mint -->

        <div class="gacha-option single-option">
          <h3>Single Mint</h3>
          <p>Get 1 random Pok√©mon</p>

          <!-- FREE FIRST MINT -->
          <p class="gacha-price" id="free-price" style="color:#00ff88;">FREE (First Time)</p>
          <button id="free-mint-btn" class="gacha-btn single free" onclick="mintRandomPokemon(1, true)">
            üéØ Mint 1 Pok√©mon (FREE)
          </button>

          <!-- NORMAL PAID MINT -->
          <p class="gacha-price" id="paid-price" style="display:none;">100 PKN</p>
          <button id="paid-mint-btn" class="gacha-btn single paid" onclick="mintRandomPokemon(1, false)" style="display:none;">
            üéØ Mint 1 Pok√©mon (100 PKN)
          </button>
        </div>
        
        <!-- Multi Mint -->
        <div class="gacha-option multi-option">
            <h3>Multi Mint</h3>
            <p>Get 5 random Pok√©mon</p>
            <p class="gacha-price"> 500 PKN
            </p>
            <button class="gacha-btn multi" onclick="mintRandomPokemon(5)">
                üéÅ Mint 5 Pok√©mon
            </button>
        </div>
        
        <!-- Premium Mint -->
        <div class="gacha-option premium-option">
            <h3>Premium Mint</h3>
            <p>Get 10 random Pok√©mon + Guaranteed Rare</p>
            <p class="gacha-price"> 1,000 PKN
            </p>
            <button class="gacha-btn premium" onclick="mintRandomPokemon(10)">
                ‚≠ê Mint 10 Pok√©mon
            </button>
        </div>
    </div>
    
    <div class="gacha-info">
        <h4>üé≤ Gacha Rates</h4>
        <div class="rarity-rates">
            <div class="rate-item common">Common: <span>70%</span></div>
            <div class="rate-item uncommon">Uncommon: <span>20%</span></div>
            <div class="rate-item rare">Rare: <span>7%</span></div>
            <div class="rate-item epic">Epic: <span>2.5%</span></div>
            <div class="rate-item legendary">Legendary: <span>0.5%</span></div>
        </div>
    </div>
</div>


<!-- NFT GRID -->
<div id="nfts-grid" class="nfts-grid">
  <p class="loading">Loading Pok√©mon...</p>
</div>

    <!-- NFT GRID -->
    <div id="nfts-grid" class="nfts-grid">
      <p class="loading">Loading Pok√©mon...</p>
    </div>
  </div>

  <div class="pagination">
  <button id="prev-btn" onclick="changePage(currentPage - 1)" class="page-btn">Previous</button>
  
  <div id="page-numbers"></div>
  
  <button id="next-btn" onclick="changePage(currentPage + 1)" class="page-btn">Next</button>
</div>

  <!-- SCRIPTS -->
   
<script>
    let initCalled = false;
    
    // Connect login button
    const loginBtn = document.getElementById("login-btn");
    if (loginBtn) {
        loginBtn.addEventListener("click", function() {
            if (!initCalled) {
                initCalled = true;
                initMarketplace();
            }
        });
    }

    // Auto-init if already connected
    window.addEventListener("load", function() {
        if (window.userAddress && typeof initMarketplace === "function") {
            // Small delay to ensure everything is loaded
            setTimeout(function() {
                if (!initCalled) {
                    initCalled = true;
                    initMarketplace();
                }
            }, 1000);
        }
    });
</script>

<script>
  function updateMintButtons() {
    const used = localStorage.getItem("hasUsedFreeMint") === "true";
    document.getElementById("free-price").style.display   = used ? "none" : "block";
    document.getElementById("free-mint-btn").style.display= used ? "none" : "block";
    document.getElementById("paid-price").style.display   = used ? "block" : "none";
    document.getElementById("paid-mint-btn").style.display= used ? "block" : "none";
  }
  // run on load
  updateMintButtons();
</script>


</body>
</html>